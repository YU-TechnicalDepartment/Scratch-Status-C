<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Scratch Cloud Status</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">

  <!-- Material Web Components -->
  <script type="module" src="https://esm.run/@material/web/all.js"></script>

  <!-- Material Icons & Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --md-sys-color-primary: #6750A4;
      --md-sys-color-surface: #FFFBFE;
      --md-sys-color-on-surface: #1C1B1F;
      --md-sys-color-outline: #79747E;
      --md-sys-color-error: #B3261E;
      --md-sys-color-success: #4CAF50;

      --tooltip-bg: #313033;
      --tooltip-fg: #F5EFF7;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --md-sys-color-primary: #D0BCFF;
        --md-sys-color-surface: #1C1B1F;
        --md-sys-color-on-surface: #E6E1E5;
        --md-sys-color-outline: #938F99;
        --md-sys-color-error: #F2B8B5;
        --md-sys-color-success: #81C995;

        --tooltip-bg: #E6E1E5;
        --tooltip-fg: #1C1B1F;
      }
    }

    body {
      margin: 0;
      background: var(--md-sys-color-surface);
      font-family: "Roboto", sans-serif;
      color: var(--md-sys-color-on-surface);
    }

    header {
      background: var(--md-sys-color-primary);
      color: white;
      padding: 20px 24px;
      font-size: 24px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .container {
      padding: 24px;
      max-width: 1000px;
      margin: auto;
    }

    md-elevated-card {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
      margin-bottom: 24px;
    }

    .chart {
      display: flex;
      gap: 2px;
      padding: 16px 0;
      overflow: hidden;
      max-width: 100%;
    }

    .bar-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bar {
      width: 10px;
      height: 60px;
      border-radius: 4px;
      transition: transform 0.12s ease;
      cursor: pointer;
    }

    .bar:hover {
      transform: scale(1.05);
    }

    .green { background: var(--md-sys-color-success); }
    .red   { background: var(--md-sys-color-error); }

    .more-button {
      display: none;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      cursor: pointer;
      color: var(--md-sys-color-primary);
      font-weight: 500;
      user-select: none;
      font-size: 13px;
    }

    .more-button:hover {
      opacity: 0.85;
    }

    .tooltip {
      position: fixed;
      z-index: 1000;
      background: var(--tooltip-bg);
      color: var(--tooltip-fg);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      pointer-events: none;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity 0.12s ease, transform 0.12s ease;
      white-space: nowrap;
    }

    .contact-link {
      color: var(--md-sys-color-primary);
      font-weight: 500;
      text-decoration: none;
    }

    .contact-link:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <header>
    <span class="material-symbols-rounded">cloud_sync</span>
    Scratch Cloud Status
  </header>

  <div class="container">

    <md-elevated-card id="stats-card">
      <h2>稼働率</h2>
      <p id="uptime-text">読み込み中…</p>
    </md-elevated-card>

    <md-elevated-card>
      <h2>クラウド変数の稼働状況</h2>
      <p>
        Scratch Cloud API の稼働状況を日次で記録しています。<br>
        緑は正常稼働、赤は異常があった日を表します。
      </p>

      <div id="chart" class="chart"></div>

      <div id="more-btn" class="more-button">
        <span class="material-symbols-rounded">arrow_back</span>
        もっと見る
      </div>
    </md-elevated-card>

    <md-elevated-card>
      <h2>お問い合わせ</h2>
      <p>
        機能の提案などは、
        <a class="contact-link" href="https://scratch.mit.edu/projects/1035981046/" target="_blank" rel="noopener noreferrer">
          こちら
        </a>
        からお願いします。
      </p>
    </md-elevated-card>

  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    const tooltip = document.getElementById('tooltip');

    function showTooltip(text, x, y) {
      tooltip.textContent = text;
      tooltip.style.left = x + 8 + 'px';
      tooltip.style.top = y - 8 + 'px';
      tooltip.style.opacity = '1';
      tooltip.style.transform = 'translateY(-6px)';
    }

    function hideTooltip() {
      tooltip.style.opacity = '0';
      tooltip.style.transform = 'translateY(-4px)';
    }

    fetch('data.json?cachebust=' + Date.now(), { cache: "no-store" })
      .then(res => res.json())
      .then(days => {
        const chart = document.getElementById('chart');
        const moreBtn = document.getElementById('more-btn');
        const uptimeText = document.getElementById('uptime-text');

        if (!Array.isArray(days) || days.length === 0) {
          uptimeText.textContent = "データがまだありません。";
          return;
        }

        let green = 0;
        let red = 0;
        days.forEach(d => {
          if (d.status === "green") green++;
          else red++;
        });

        const uptime = (green / (green + red) * 100).toFixed(1);
        uptimeText.textContent =
          `稼働率：${uptime}%（正常：${green}日 / 異常：${red}日）`;

        const MAX_DAYS = 83;
        const visibleDays = days.slice(-MAX_DAYS);
        const hiddenDays = days.slice(0, -MAX_DAYS);

        function render(list) {
          chart.innerHTML = "";
          list.forEach(day => {
            const wrap = document.createElement('div');
            wrap.className = 'bar-wrapper';

            const bar = document.createElement('div');
            bar.className = 'bar ' + day.status;

            bar.addEventListener('mouseenter', (e) => {
              const text = `${day.date} / HTTP ${day.code} / ${day.status === 'green' ? '正常' : '異常'}`;
              showTooltip(text, e.clientX, e.clientY);
            });

            bar.addEventListener('mousemove', (e) => {
              showTooltip(tooltip.textContent, e.clientX, e.clientY);
            });

            bar.addEventListener('mouseleave', () => {
              hideTooltip();
            });

            wrap.appendChild(bar);
            chart.appendChild(wrap);
          });
        }

        render(visibleDays);

        if (hiddenDays.length > 0) {
          moreBtn.style.display = "flex";
          moreBtn.onclick = () => {
            render(days);
            chart.style.overflowX = "auto";
            moreBtn.style.display = "none";
          };
        }
      });
  </script>
</body>
</html>
