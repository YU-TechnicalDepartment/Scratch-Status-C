name: Daily Status Check

permissions:
  contents: write

on:
  schedule:
    - cron: "0 15 * * *"  # 毎日0時（JST）
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # ★ これが無いと Node が無くて workflow が起動しない
      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch Scratch Cloud Logs
        run: |
          curl -s -o logs.json -w "%{http_code}\n" \
          "https://clouddata.scratch.mit.edu/logs?projectid=60917032&limit=40&offset=0" \
          > status_code.txt

      - name: Determine status
        run: |
          node << 'EOF'
          const fs = require('fs');

          const statusCode = fs.readFileSync('status_code.txt', 'utf8').trim();
          const status = (statusCode === "502") ? "red" : "green";
          const today = new Date().toISOString().slice(0, 10);

          let data = [];
          try {
            if (fs.existsSync('data.json')) {
              data = JSON.parse(fs.readFileSync('data.json', 'utf8'));
            }
          } catch (e) {
            data = [];
          }

          const idx = data.findIndex(d => d.date === today);
          if (idx >= 0) {
            data[idx].status = status;
            data[idx].code = statusCode;
          } else {
            data.push({ date: today, status, code: statusCode });
          }

          fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data.json
          git commit -m "Update daily status" || echo "No changes"
          git push
